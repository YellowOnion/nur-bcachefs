From 5d64cc7c22cb3a8bc2a7220c6bd63d8aa7d3c52c Mon Sep 17 00:00:00 2001
From: Daniel Hill <daniel@gluo.nz>
Date: Mon, 9 Jan 2023 01:49:42 +1300
Subject: [PATCH] bcachefs: add tracepoint for bch2_alloc_sectors_trans()

Signed-off-by: Daniel Hill <daniel@gluo.nz>
---
 fs/bcachefs/alloc_foreground.c  | 31 ++++++++++++++++++++++++++++++-
 include/trace/events/bcachefs.h | 13 +++++++++++++
 2 files changed, 43 insertions(+), 1 deletion(-)

diff --git a/fs/bcachefs/alloc_foreground.c b/fs/bcachefs/alloc_foreground.c
index badf1075c9bf..de48c58a1f0e 100644
--- a/fs/bcachefs/alloc_foreground.c
+++ b/fs/bcachefs/alloc_foreground.c
@@ -1129,7 +1129,7 @@ static struct write_point *writepoint_find(struct btree_trans *trans,
 /*
  * Get us an open_bucket we can allocate from, return with it locked:
  */
-struct write_point *bch2_alloc_sectors_start_trans(struct btree_trans *trans,
+struct write_point *__bch2_alloc_sectors_start_trans(struct btree_trans *trans,
 				unsigned target,
 				unsigned erasure_code,
 				struct write_point_specifier write_point,
@@ -1240,7 +1240,36 @@ struct write_point *bch2_alloc_sectors_start_trans(struct btree_trans *trans,
 
 	return ERR_PTR(ret);
 }
+struct write_point *bch2_alloc_sectors_start_trans(struct btree_trans *trans,
+				unsigned target,
+				unsigned erasure_code,
+				struct write_point_specifier write_point,
+				struct bch_devs_list *devs_have,
+				unsigned nr_replicas,
+				unsigned nr_replicas_required,
+				enum alloc_reserve reserve,
+				unsigned flags,
+				struct closure *cl)
+{
+	struct write_point *wp;
+	int ret;
 
+	wp = __bch2_alloc_sectors_start_trans(trans,
+					      target,
+					      erasure_code,
+					      write_point,
+					      devs_have,
+					      nr_replicas,
+					      nr_replicas_required,
+					      reserve,
+					      flags,
+					      cl);
+	ret = PTR_ERR_OR_ZERO(wp);
+
+	trace_alloc_sector_trans(trans->c, bch2_err_str(ret), bch2_err_matches(ret, BCH_ERR_transaction_restart));
+
+	return wp;
+}
 struct bch_extent_ptr bch2_ob_ptr(struct bch_fs *c, struct open_bucket *ob)
 {
 	struct bch_dev *ca = bch_dev_bkey_exists(c, ob->dev);
diff --git a/include/trace/events/bcachefs.h b/include/trace/events/bcachefs.h
index 44fcfe3f148a..1be382de8c4e 100644
--- a/include/trace/events/bcachefs.h
+++ b/include/trace/events/bcachefs.h
@@ -656,6 +656,19 @@ TRACE_EVENT(bucket_invalidate,
 		  __entry->sectors)
 );
 
+TRACE_EVENT(alloc_sector_trans,
+	TP_PROTO(struct bch_fs *c, const char *err, bool restart),
+	TP_ARGS(c, err, restart),
+	TP_STRUCT__entry(
+		    __array(char, err, 32)
+		    __field(bool, restart)
+	),
+	TP_fast_assign(
+		    strscpy(__entry->err, err, sizeof(__entry->err));
+		    __entry->restart = restart;
+	),
+	TP_printk("err %s restart %s", __entry->err, __entry->restart ? "true" : "false")
+);
 /* Moving IO */
 
 DEFINE_EVENT(bkey, move_extent_read,
-- 
2.37.2

